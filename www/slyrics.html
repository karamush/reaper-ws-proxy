<!DOCTYPE html>
<html lang="ru">
<head>
	<title>REAPER Scrolling Lyrics Web Interface - X-Raym</title>
	<meta charset="utf-8"/>
	<style>
* {
	box-sizing: border-box;
}

body {
	background: #333333;
	color: white;
	font-family: sans-serif;
}

body:has(#vignette) {
	background: #000000;
}

body:has(.lyrics) #vignette {
	position: fixed;
	width: 100%;
	left: 0;
	top: 0;
	height: 100%;
	z-index: 100;
	background: linear-gradient(0deg, rgba(0,0,0,1) 0%, rgba(94,94,94,1) 0%, rgba(0,0,0,1) 0%, rgba(0,0,0,1) 25%, rgba(0,0,0,0) 50%, rgba(0,0,0,1) 75%, rgba(0,0,0,1) 100%);
	opacity: 0;
	pointer-events: none;
}

#text {
	margin: auto;
	text-align: center;
}

#text:has(.lyrics) {
  padding: 50vw 0;
}

.container {
	text-align: center;
}

ol, ul, dl {
	display:inline-block;
	text-align:left;
}

#playstate {
	display: none;
	height: 30px;
	width: 100%;
	background: blue;
	position: fixed;
	bottom: 0;
	left: 0;
	z-index: 200;
}

body:has(.fullheight) #playstate {
	display: none;
}

body:has(.vignette) #playstate {
	display:none;
}

a {
	color: #ea8400;
}

.lyrics {
	opacity: 0.5;
	transition: all ease 0.3s;
	font-size: 3em;
}

.fullheight .lyrics {
	margin-bottom: 50vh;
}

.lyrics:hover {
	cursor: pointer;
}

.current {
	opacity: 1;
	/*font-size: 4em;*/
}

strong {
	color: red;
	font-size: 2em;
}

ul li {
	color: #ea8400;
}

ul li:hover {
	cursor:pointer;
	text-decoration: underline;
	text-decoration-color: #ea8400;
}

ul li:active {
	text-decoration-color: white;
	color: white;
}

	</style>
</head>
<body>

<div id="vignette"></div>
<div id="text"></div>
<div id="playstate"></div>

<script src="main.js"></script>
<script>
wwr_start();
// wwr_req("GET/EXTSTATE/TUX/json;SET/EXTSTATE/TUX/need_refresh/false");
wwr_req_recur("GET/EXTSTATE/TUX/need_refresh;TRANSPORT",10);

var div = document.getElementById('text');
var playstate_elm = document.getElementById('playstate');
var colors = ["#000000", "#00FF00", "#FFFF00", "#000000", "#000000", "#FF0000", "#FFFF00"] // playstate is 0 for stopped, 1 for playing, 2 for paused, 5 for recording, and 6 for record paused.
var first_run = true;
var json = [];
var paragraphs = [];

var vignette_elm = document.getElementById('vignette')

var searchParams = new URLSearchParams(window.location.search)
if ( searchParams.has('vignette') ) {
	vignette_elm.style.opacity = "1"
	div.classList.add("vignette")
}
if ( searchParams.has('fullheight') ) {
	var fullheight = true
	div.classList.add("fullheight")
}

if ( searchParams.has('font') && searchParams.get('font') !== "" ) {
	div.style.fontFamily = searchParams.get('font')
}

function wwr_onreply(results) {
	var ar = results.split("\n");
	var x;
	for (x=0;x<ar.length;x++) {
		var tok = ar[x].split("\t");
		if (tok.length > 1 && tok[1] === "TUX" && tok[2] === "need_refresh" && (tok[3] === "true" || first_run === true ) ) {
			wwr_req("GET/EXTSTATE/TUX/json;SET/EXTSTATE/TUX/need_refresh/false");
			first_run = false;
		}

		if (tok.length > 1 && tok[1] === "TUX" && tok[2] === "json" && tok[3] !== "") {
			var text = tok[3].replaceAll(/\\n/gmi, "\n").replaceAll(/\\\\/gmi, "\\");
			json = JSON.parse( text );
			var t = [];
			var last_end = 0
			for( let line of json.entry ) {
				line.pos_start = parseFloat(line.pos_start);
				line.pos_end = parseFloat(line.pos_end);
				if( fullheight && last_end < line.pos_start ) {
					t.push( '<p class="lyrics" data-pos-start="' + last_end + '" data-pos-end="' + line.pos_start + '">' + "<br>" + '</p>' );
				}
				t.push( '<p class="lyrics" data-pos-start="' + line.pos_start + '" data-pos-end="' + line.pos_end + '">' + line.text + '</p>' );
				last_end = line.pos_end
			}
			t.push( '<p class="lyrics" data-pos-start="' + last_end + '" data-pos-end="' + (last_end+1000) + '">' + "<br>" + '</p>' );

			div.innerHTML = t.join("\n");
			paragraphs = document.getElementsByTagName("p");
		}

		if (tok.length > 1 && tok[0] === "TRANSPORT" ){ // TRANSPORT \t playstate \t position_seconds \t isRepeatOn \t position_string \t position_string_beats
			playstate_elm.style.background= colors[tok[1]];

			var time = parseFloat( tok[2] );
			var i = 0;
			if( json.entry !== undefined ) {
				for( let p of paragraphs ) {
					if (time >= parseFloat( p.getAttribute("data-pos-start") ) -0.000001 && time <= parseFloat( p.getAttribute("data-pos-end")) ) {
						p.classList.add("current");
						if( parseInt( tok[1] ) > 0 ) {
							p.scrollIntoView({
								behavior: 'instant',
								block: 'center',
								inline: 'center'
							})
						}
					} else {
						p.classList.remove("current");
					}
					i++;
				}
			}
		}

	}

}
</script>

</body>
</html>
